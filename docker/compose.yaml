# use this compose with existing traefik setup

name: ${COMPOSE_NAME}
services:
  # Base Profile: Flowise
  flowise-db:
    image: postgres:16-alpine
    restart: always
    profiles:
      - flowise
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - flowise-db-data:/var/lib/postgresql/data
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - default
  flowise:
    image: flowiseai/flowise:3.0.12
    restart: always
    profiles:
      - flowise
    environment:
      - PORT=${FLOWISE_PORT}
      - FLOWISE_USERNAME=${FLOWISE_USERNAME}
      - FLOWISE_PASSWORD=${FLOWISE_PASSWORD}
      - DATABASE_TYPE=postgres
      - DATABASE_PORT=5432
      - DATABASE_HOST=flowise-db
      - DATABASE_NAME=${POSTGRES_DB}
      - DATABASE_USER=${POSTGRES_USER}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - APIKEY_PATH=/root/.flowise
      - SECRETKEY_PATH=/root/.flowise
      - LOG_LEVEL=info
      - LOG_PATH=/root/.flowise/logs
    volumes:
      - flowise-data:/root/.flowise
    depends_on:
      flowise-db:
        condition: service_healthy
    networks:
      - default
      - traefik-proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK}
      - traefik.http.routers.flowise.rule=Host(`${FLOWISE_SUBDOMAIN}.${DOMAIN_NAME}`)
      - traefik.http.routers.flowise.entrypoints=websecure
      - traefik.http.routers.flowise.tls.certresolver=${TRAEFIK_CERT_RESOLVER}
      - traefik.http.services.flowise.loadbalancer.server.port=${FLOWISE_PORT}
  # Profile: Upload (gowise Stack)
  ollama:
    image: ollama/ollama:0.15.4
    profiles:
      - upload
    volumes:
      - ollama_data:/root/.ollama
    restart: always
    networks:
      - default
  chromadb:
    image: chromadb/chroma:1.4.1
    profiles:
      - upload
    # ports:
    #   - "127.0.0.1:8000:8000"
    volumes:
      - chroma_data:/data
    environment:
      - IS_PERSISTENT=TRUE
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
      # OpenTelemetry Config (Optional - pre-configured)
      # - CHROMA_OTEL_COLLECTION_ENDPOINT=http://otel-collector:4317
      # - CHROMA_OTEL_SERVICE_NAME=chromadb
      # - CHROMA_OTEL_GRANULARITY=all
    restart: always
    networks:
      - default
  gowise:
    image: ${APP_IMAGE}:${APP_IMAGE_TAG}
    restart: always
    profiles:
      - upload
    environment:
      - OLLAMA_URL=${OLLAMA_URL}
      - CHROMA_URL=${CHROMA_URL}
      - EMBEDDING_MODELS=${EMBEDDING_MODELS}
      - COLLECTION_NAME=${COLLECTION_NAME}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - PORT=${APP_PORT}
    depends_on:
      - ollama
      - chromadb
    networks:
      - default
      - traefik-proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK}
      - traefik.http.routers.gowise.rule=Host(`${GOWISE_SUBDOMAIN}.${DOMAIN_NAME}`)
      - traefik.http.routers.gowise.entrypoints=websecure
      - traefik.http.routers.gowise.tls.certresolver=${TRAEFIK_CERT_RESOLVER}
      - traefik.http.services.gowise.loadbalancer.server.port=${APP_PORT}
networks:
  default: null
  traefik-proxy:
    external: true
    name: ${TRAEFIK_NETWORK}
volumes:
  flowise-db-data: null
  flowise-data: null
  chroma_data: null
  ollama_data: null
